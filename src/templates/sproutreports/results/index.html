{% extends "_layouts/cp" %}

{% set title  = 'Sprout Reports'|t %}

{% set selectedSubnavItem = craft.app.request.segment(2) %}
{% if dataSource is defined %}
    {% set settingsHtml = dataSource.getSettingsHtml() %}
{% endif %}

{% set crumbs = [
    { label: "Reports"|t('sprout-base'), url: url('sprout-reports') },
    { label: "Edit "|t('sprout-base') ~ report.name, url: report.getEditUrl() }
] %}

{% block actionButton %}
    <form method="post" accept-charset="UTF-8">
        {{ csrfInput() }}
        <input type="hidden" name="action"
               value="sprout-base/reports/export-report">
        <input type="hidden" name="reportId" value="{{ reportId }}">

        <a id="btn-download-csv" class="btn">
            {{ "Download"|t('sprout-reports') }}
        </a>

        <a id="modify-settings-icon" class="btn" data-icon="settings"></a>
    </form>
{% endblock %}

{% block content %}

    {% if settingsHtml %}

        <div id="modify-settings-panel">

            <form id="report-settings" method="post" accept-charset="UTF-8">
                {{ csrfInput() }}
                {{ redirectInput(redirectUrl) }}
                <input type="hidden" name="action"
                       value="sprout-base/reports/update-report">
                <input type="hidden" name="reportId" value="{{ reportId }}">

                {{ settingsHtml | raw }}

                <div class="button">
                    <div class="btngroup">
                        <input type="submit" class="btn submit"
                               value="{{ 'Submit Report'|t('sprout-base') }}">
                    </div>
                </div>

            </form>

            <hr>

        </div>

    {% endif %}

    <div class="tableview sproutreports">
        {% if values is defined and values is iterable and values|length %}
            <div class="tablecontent">
                <table class="data fullwidth">
                    <thead>
                    <tr>
                        {% for label in labels %}
                            <th>
                                <div {% if loop.index == "1" %}class="first"{% endif %}>
                                    <h3>{{ label }}</h3></div>
                            </th>
                        {% endfor %}
                    </tr>
                    </thead>
                    <tbody>
                    {% for value in values %}
                        <tr class="table_row">
                            {% for property in value %}
                                <td>
                                    <div class="item_content">
                                        {% if report.allowHtml %}
                                            {{ property|raw }}
                                        {% else %}
                                            {{ property }}
                                        {% endif %}
                                    </div>
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p>{{ "This report currently has no results."|t('sprout-base') }}</p>
        {% endif %}
    </div>

{% endblock %}

{% do view.registerAssetBundle("barrelstrength\\sproutbase\\web\\assets\\sproutreports\\SproutReportsAsset") %}

{% js %}

    (function(){

    $('#btn-download-csv').on('click', function(event) {

    event.preventDefault();

    $form = $(this).parents('form');
    $form.submit();

    });

    $('#modify-settings-icon').on('click', function() {
    $('#modify-settings-panel').slideToggle('slow');
    });

    })();

{% endjs %}