{% extends "sprout/_layouts/base" %}
{% import "sprout/_includes/sproutcp" as sproutCp %}
{% import "_includes/forms" as forms %}

{% set selectedSubnavItem = 'entries' %}

{% set crumbs = [
    { label: "Entries"|t('sprout'), url: cpUrl('sprout/forms/entries') }
] %}

{% set title = 'Edit Entry'|t('sprout') %}

{% set fullPageForm = true %}
{% set saveShortcutRedirect = 'sprout/forms/entries/edit/' ~ entryId %}

{% block actionButton %}
    <div class="buttons">
        {% if currentUser.can('sproutForms-editEntries') %}
            <div class="btngroup submit first">
                <input type="submit" class="btn submit" value="{{ 'Save'|t('sprout') }}">
                {% if entryId != null %}
                    <div class="btn submit menubtn"></div>
                    <div class="menu">
                        <hr>
                        <ul>
                            <li><a class="formsubmit error"
                                    data-action="sprout/form-entries/delete-entry"
                                    data-confirm='{{ "Are you sure you want to delete this entry and all of it's data?"|t('sprout') }}'
                                    data-redirect="{{ 'sprout/forms/entries'|hash }}">{{ "Delete"|t('sprout') }}</a>
                            </li>
                        </ul>
                    </div>
                {% endif %}
            </div>
        {% endif %}

        {% if config.getEnableUpgradeMessages() and config.isUpgradable() %}
            {{ sproutCp.upgradeToProButton({
                url: config.getUpgradeUrl(),
                title: config.getUpgradeMessage()
            }) }}
        {% endif %}

    </div>
{% endblock %}

{% block content %}

    <input type="hidden" name="action" value="sprout/form-entries/save-entry">
    <input type="hidden" name="handle" value="{{ form.handle }}">
    <input type="hidden" name="entryId" value="{{ entryId }}">

    {% if namespace is not defined %}{% set namespace = 'fields' %}{% endif %}

    <div id="fields">

        {% for tab in fieldLayoutTabs %}

            {% set fields = tab.getFields() %}

            <div id="tab{{ loop.index }}"
                {% if not loop.first %}class="hidden"{% endif %}>

                {% namespace namespace %}

                    {% for field in fields %}
                        {% include "_includes/field" with {
                            field:    field,
                            required: field.required,
                            element:  entry,
                            static: null
                        } only %}
                    {% endfor %}

                {% endnamespace %}

            </div>

        {% endfor %}

    </div>

    {% hook 'cp.sproutForms.entries.edit.content' %}

{% endblock %}

{% block details %}

    <div class="meta">

        {% set formName = "<h6>" ~ form.name ~ "</h6>" %}

        {{ forms.field({
            label: "Form Name"|t('sprout'),
        }, formName) }}

        {{ forms.selectField({
            label: "Entry Status"|t('sprout'),
            id: 'statusId',
            name: 'statusId',
            value: entry.statusId,
            options: statuses,
            errors: entry.getErrors('statusId')
        }) }}

    </div>
    <hr>
    <div class="meta read-only">
        <div class="data">
            <h5 class="heading">{{ "Submitted"|t('sprout') }}</h5>
            <div class="value">{{ entry.dateCreated|datetime('short') }}</div>
        </div>
    </div>

    {% set integrationLogs = entry.integrationLog() %}
    {% if integrationLogs %}
        <div class="meta read-only">
            <h6 class="title">{{ "Integrations"|t('sprout') }}</h6>
            <hr>
            {% for integrationLog in integrationLogs %}
                <div class="data">
                    {% set integration = sprout.app.formIntegrations.getIntegrationById(integrationLog.integrationId) %}
                    <h5 class="heading">{{ integration.name }}</h5>
                    {% if integrationLog.success %}
                        {% if integrationLog.status == 'notsent' %}
                            <div class="value"><span class="status pending"></span>
                                {{ "Not Sent"|t('sprout') }}
                                <span class="info">{{ integrationLog.message }}</span>
                            </div>
                        {% else %}
                            <div class="value"><span class="status live"></span>
                                {{ "Success"|t('sprout') }}
                                <span class="info">{{ integrationLog.message }}</span>
                            </div>
                        {% endif %}
                    {% else %}
                        {% if integrationLog.status == 'pending' %}
                            <div class="value"><span class="status pending"></span>
                                {{ "Pending"|t('sprout') }}
                                <span class="info">{{ integrationLog.message }}</span>
                            </div>
                        {% else %}
                            <div class="value"><span class="status disabled"></span>
                                {{ "Error"|t('sprout') }}
                                <span class="info">{{ integrationLog.message }}</span>
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    {% if entry.getSavedCaptchaErrors()|length %}
        <div class="meta read-only">
            <h6 class="title">{{ "Failed Captchas"|t('sprout') }}</h6>
            <hr>
            {% for captchaError in entry.getSavedCaptchaErrors() %}
                <div class="data">
                    {% set captcha = create(captchaError.type) %}
                    <div style="padding-top:8px;"><span class="status error"></span>
                        {{ captcha.name }}
                        <span class="info">{{ captchaError.errors }}</span>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    {% hook 'cp.sproutForms.entries.edit.details' %}

{% endblock %}

{% js on ready %}
    {% if not currentUser.can('sproutForms-editEntries') %}
        var form = document.getElementById('main-form');
        var inputs = form.querySelectorAll('input, select, option, textarea, button, datalist, output');
        inputs.forEach(function(input) {
        input.readOnly = true;
        });
    {% endif %}
{% endjs %}

{% css %}
    #content-container #tabs ul{
    width: 100% !important;
    display: flex;
    overflow-x: auto;
    overflow-y: hidden;
    white-space: nowrap;
    }

    #content-container #tabs ul li {
    display: inline-table;
    }

{% endcss %}

